import{r as e,j as t}from"./vendor-CPG4Elxd.js";import{c as a}from"./database-C7DZEwQH.js";import{A as s,m as l}from"./framer-motion-BhUfCpNs.js";import.meta;let i;i="postgresql://neondb_owner:npg_BIpmCq67lMrb@ep-quiet-pine-aefsvs3p-pooler.c-2.us-east-2.aws.neon.tech/neondb?channel_binding=require&sslmode=require";const r=a(i),c=new Map,n=async()=>{try{const e=[{name:"爱心",image_url:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNMjU2IDE3NmMzMy4xIDAgNjAtMjYuOSA2MC02MHMtMjYuOS02MC02MC02MC02MCAyNi45LTYwIDYwIDI2LjkgNjAgNjAgNjB6Ii8+PC9zdmc+"},{name:"祝福",image_url:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNMjU2IDI1NmMxMS4wNSAwIDIwLTguOTUgMjAtMjBzLTguOTUtMjAtMjAtMjAtMjAgOC45NS0yMCAyMCA4Ljk1IDIwIDIwIDIweiIvPjwvc3ZnPg=="},{name:"星星",image_url:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNNDI3IDI1Nmw2My42NCAzNi43My0yNi41NiA3OS4xMy03OS4xMy0yNi41Ni0xLjgxIDkyLjE0LTc3LjMyLTE5Ljc4LTQzLjQ1IDU4LjQ4LTk0Ljc3LTEwLjY2LTgwLjQ0LTY2LjU2IDY0LjEyLTU0LjE5IDkxLjI0IDQ4LjIzIDY3LjI3LTEwOS45MyA0My40NS01OC40OCA2Ni41Ni0xMTIuMjkgNi4xMi05Ni40NCA2NC4xMi0xOC4wOSAxMDIuOTQtNjQuMTIgNTkuMTIgNDkuMzMgNjQuMTIgMTI0LjU0LTEwLjY2IDkyLjE0IDkwLjE0IDgwLjQ0IDY0LjEyIDgwLjQ0LTYyLjI3LTc3LjMyLTE5Ljc4LTEwMS40MyA0OC40OC0xMTIuMjkgNDguNDgtMTQuOTYgMC00My40NS00OC40OC00My40NS00OC40OFYyMDZjMC0yNy42MiAyMi4zOC01MCA1MC01MHM1MCAyMi4zOCA1MCA1MC0yMi4zOCA1MC01MCA1MCIvPjwvc3ZnPg=="},{name:"气球",image_url:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNMjU2IDE0NGMxMS4wNSAwIDIwLTguOTUgMjAtMjBzLTguOTUtMjAtMjAtMjAtMjAgOC45NS0yMCAyMCA4Ljk1IDIwIDIwIDIweiIvPjxwYXRoIGQ9Ik0yNTYgMTI0Yy0yNS40MSAwLTQ2IDIwLjU5LTQ2IDQ2czIwLjU5IDQ2IDQ2IDQ2IDQ2LTIwLjU5IDQ2LTQ2LTIwLjU5LTQ2LTQ2LTQ2em0wLTEyYzI3LjYyIDAgNTAtMjIuMzggNTAtNTBTMjgzLjYyIDAgMjU2IDAgMjA2IDIyLjM4IDIwNiA1MCA1MCA1MCA1MC0yMi4zOCA1MC01MHoiLz48L3N2Zz4="},{name:"烟花",image_url:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNNDI3IDI1NmwtMTEuMzEgMTkuNTctOS4yOS0yMS43Ny0yMS43Ny05LjI5IDIxLjc3LTkuMjkgOS4yOS0yMS43Ny05LjI5IDIxLjc3IDIxLjc3IDkuMjktOS4yOSAyMS43Ny05LjI5IDkuMjkgMjEuNzcgOS4yOXptLTE3MS00NmwxOS41Ny0xMS4zMS0yMS43Ny05LjI5LTkuMjkgMjEuNzcgMjEuNzcgOS4yOS05LjI5IDIxLjc3IDIxLjc3IDkuMjktMjEuNzcgOS4yOXpNMjU2IDE3M2wxOS41Ny0xMS4zMS0yMS43Ny05LjI5LTkuMjkgMjEuNzcgMjEuNzcgOS4yOS05LjI5IDIxLjc3IDIxLjc3IDkuMjktMjEuNzcgOS4yOXptMCAxNzZsMTkuNTctMTEuMzEtMjEuNzctOS4yOS05LjI5IDIxLjc3IDIxLjc3IDkuMjktOS4yOSAyMS43NyAyMS43NyA5LjI5LTIxLjc3IDkuMjl6TTQyNyAzMzRsLTExLjMxIDE5LjU3LTkuMjktMjEuNzctMjEuNzctOS4yOSAyMS43Ny05LjI5IDkuMjktMjEuNzctOS4yOSAyMS43NyAyMS43NyA5LjI5LTkuMjkgMjEuNzctOS4yOSA5LjI5IDIxLjc3IDkuMjl6Ii8+PC9zdmc+"}];for(const t of e)await(r`
        INSERT INTO sticker_pack (name, image_url)
        VALUES (${t.name}, ${t.image_url});
      `)}catch(e){}},o=async(e=!1)=>{const t="blessingsWithMedia";if(!e&&c.has(t)){const e=c.get(t);if(Date.now()-e.timestamp<3e5)return e.data}try{try{const e=await(r`
        SELECT b.id, b.name, b.message, b.avatar_url, b.photo_url, b.audio_url, b.sticker_id, b.created_at, 
               s.name as sticker_name, s.image_url as sticker_image_url
        FROM blessings b
        LEFT JOIN sticker_pack s ON b.sticker_id = s.id
        ORDER BY b.created_at DESC;
      `);return c.set(t,{data:e,timestamp:Date.now()}),e}catch(a){const e=(await(r`
        SELECT id, name, message, avatar_url, created_at, photo_url, audio_url
        FROM blessings 
        ORDER BY created_at DESC;
      `)).map(e=>({...e,sticker_id:null,sticker_name:null,sticker_image_url:null}));return c.set(t,{data:e,timestamp:Date.now()}),e}}catch(s){return[]}};function d({opacity:e=.1}){return t.jsxs(t.Fragment,{children:[t.jsx("svg",{className:"absolute left-10 top-10",width:"120",height:"60",style:{opacity:e},children:t.jsx("ellipse",{cx:"60",cy:"30",rx:"60",ry:"30",fill:"#FFF8F5"})}),t.jsx("svg",{className:"absolute right-20 top-24",width:"100",height:"50",style:{opacity:e},children:t.jsx("ellipse",{cx:"50",cy:"25",rx:"50",ry:"25",fill:"#FFF8F5"})}),t.jsx("svg",{className:"absolute left-1/3 bottom-10",width:"140",height:"70",style:{opacity:e},children:t.jsx("ellipse",{cx:"70",cy:"35",rx:"70",ry:"35",fill:"#FFF8F5"})})]})}function u(){return t.jsxs(l.div,{className:"relative mx-auto mt-8 mb-12",initial:{y:60,opacity:0},animate:{y:0,opacity:1},transition:{duration:1},style:{width:120,height:180},children:[t.jsxs("svg",{width:"120",height:"180",viewBox:"0 0 120 180",children:[t.jsx("ellipse",{cx:"60",cy:"30",rx:"50",ry:"20",fill:"#b87333"}),t.jsx("rect",{x:"10",y:"30",width:"100",height:"120",rx:"20",fill:"#b87333"}),t.jsx("ellipse",{cx:"60",cy:"150",rx:"50",ry:"20",fill:"#a05a2c"}),t.jsx("rect",{x:"35",y:"60",width:"50",height:"20",rx:"6",fill:"#fff"}),t.jsx("rect",{x:"45",y:"65",width:"30",height:"10",rx:"3",fill:"#b87333"})]}),t.jsx(l.div,{className:"absolute left-1/2 top-16",style:{transform:"translate(-50%,0)"},animate:{y:[0,-30,0],opacity:[1,.7,1]},transition:{duration:2.5,repeat:1/0},children:t.jsxs("svg",{width:"40",height:"28",viewBox:"0 0 40 28",children:[t.jsx("rect",{x:"2",y:"4",width:"36",height:"20",rx:"4",fill:"#fff",stroke:"#b87333",strokeWidth:"2"}),t.jsx("polyline",{points:"2,4 20,18 38,4",fill:"none",stroke:"#b87333",strokeWidth:"2"})]})})]})}function m({b:e,onClick:a}){var s;return t.jsxs(l.div,{className:"relative cursor-pointer group",whileHover:{scale:1.12,zIndex:10},onClick:a,style:{width:60,height:42},children:[t.jsxs("svg",{width:"60",height:"42",viewBox:"0 0 60 42",children:[t.jsx("rect",{x:"2",y:"6",width:"56",height:"30",rx:"7",fill:"#fff",stroke:"#b87333",strokeWidth:"2"}),t.jsx("polyline",{points:"2,6 30,30 58,6",fill:"none",stroke:"#b87333",strokeWidth:"2"})]}),t.jsx("div",{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-[#BFC9FF] border-2 border-white flex items-center justify-center overflow-hidden shadow",children:e.avatar_url?t.jsx("img",{src:e.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):t.jsx("span",{className:"text-lg text-white",children:(null==(s=e.name)?void 0:s[0])||"匿"})}),t.jsxs("div",{className:"absolute left-1/2 bottom-0 -translate-x-1/2 translate-y-1/2 text-xs text-[#b87333] bg-white/80 px-2 py-0.5 rounded shadow opacity-0 group-hover:opacity-100 transition",children:[e.message.slice(0,8),e.message.length>8?"...":""]})]})}function x({blessings:a}){const[s,i]=e.useState([]);return e.useEffect(()=>{const e=Array.from({length:8}).map((e,t)=>{var s,l;return{left:5+90*Math.random(),delay:.2+.3*t,text:(null==(l=null==(s=a[t%a.length])?void 0:s.message)?void 0:l.slice(0,10))||""}});i(e);const t=setTimeout(()=>i([]),3200);return()=>clearTimeout(t)},[a]),s.length?t.jsx("div",{className:"pointer-events-none fixed left-0 top-0 w-full h-40 z-50",children:s.map((e,a)=>t.jsx(l.div,{initial:{x:`${e.left}vw`,y:-40,opacity:0},animate:{x:`${e.left+10}vw`,y:120,opacity:[0,1,.7,0]},transition:{duration:1.8,delay:e.delay},className:"absolute",children:t.jsxs("div",{className:"w-32 flex items-center gap-2",children:[t.jsx("div",{className:"h-1 w-16 bg-gradient-to-r from-white via-[#F7D6E0] to-transparent rounded-full"}),t.jsx("span",{className:"text-xs text-white drop-shadow font-cursive",children:e.text})]})},a))}):null}function j(){var a;const[i,c]=e.useState(""),[j,y]=e.useState(""),[h,g]=e.useState([]),[M,I]=e.useState(!0),[N,p]=e.useState(!1),[f,b]=e.useState(null),[w,v]=e.useState(!1),[L,T]=e.useState(null),[C,S]=e.useState(null),[A,k]=e.useState(!1),D=e.useRef(null),E=e.useRef([]);e.useEffect(()=>{const e=[{id:"mock1",name:"匿名祝福者",message:"新婚快乐，百年好合！",created_at:(new Date).toISOString(),avatar_url:null,photo_url:null,audio_url:null,sticker_id:null,sticker_name:null,sticker_image_url:null},{id:"mock2",name:"亲友团",message:"永结同心，幸福美满！",created_at:new Date(Date.now()-36e5).toISOString(),avatar_url:null,photo_url:null,audio_url:null,sticker_id:null,sticker_name:null,sticker_image_url:null}];g(e);const t=localStorage.getItem("hasInitializedTables"),a=async()=>{try{const e=await o();e&&e.length>0&&g(e)}catch(e){}finally{I(!1)}};Promise.all([(async()=>{try{t||(await(async()=>{try{const e=(await(r`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'blessings' 
        AND column_name IN ('photo_url', 'audio_url', 'sticker_id');
    `)).map(e=>e.column_name),t=[];if(e.includes("photo_url")||t.push("ADD COLUMN photo_url TEXT"),e.includes("audio_url")||t.push("ADD COLUMN audio_url TEXT"),e.includes("sticker_id")||t.push("ADD COLUMN sticker_id INTEGER"),t.length>0)for(const a of t)await(r`ALTER TABLE blessings ${a}`);(await(r`
      SELECT EXISTS (
        SELECT FROM information_schema.tables 
        WHERE table_name = 'sticker_pack'
      );
    `))[0].exists||(await(r`
        CREATE TABLE sticker_pack (
          id SERIAL PRIMARY KEY,
          name VARCHAR(50) NOT NULL,
          image_url TEXT NOT NULL,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
      `),await n())}catch(e){}})(),localStorage.setItem("hasInitializedTables","true"))}catch(e){}})(),a()]);const s=setInterval(a,3e5);return()=>clearInterval(s)},[]),e.useEffect(()=>{const e=setTimeout(()=>v(!0),3e4);return()=>clearTimeout(e)},[]);const _=async e=>{const t=e.target.files[0];if(t)try{if(t.size>5242880)return void alert("文件过大，请选择小于5MB的图片");I(!0);const e=URL.createObjectURL(t);T(e);const a=await(async e=>{try{return new Promise(t=>{const a=new FileReader;a.onload=e=>{t(e.target.result)},a.readAsDataURL(e)})}catch(t){throw t}})(t);T(a)}catch(a){alert("上传照片失败，请重试"),T(null)}finally{I(!1),e.target.value=""}};e.useEffect(()=>()=>{L&&L.startsWith("blob:")&&URL.revokeObjectURL(L),C&&C.startsWith("blob:")&&URL.revokeObjectURL(C),D.current&&A&&D.current.stop()},[L,C,A]);const O=e=>{"photo"===e?T(null):"audio"===e&&S(null)};return t.jsxs("div",{className:"relative min-h-[600px] bg-gradient-to-b from-[#0B0C2B] via-[#BFC9FF]/30 to-[#0B0C2B] rounded-3xl overflow-hidden shadow-xl py-12",children:[t.jsx(d,{opacity:.12}),w&&t.jsx(x,{blessings:h}),t.jsx(u,{}),t.jsx("div",{className:"relative flex flex-wrap justify-center gap-6 px-4 mt-2 min-h-[180px]",children:M?t.jsx("div",{className:"text-white/80",children:"加载中…"}):h.map((e,a)=>t.jsx(m,{b:e,onClick:()=>b(e)},e.id))}),t.jsxs("button",{className:"fixed md:absolute right-4 md:right-8 bottom-4 md:bottom-8 z-30 bg-[#A8C3A4] hover:bg-[#F9C784] text-[#0B0C2B] rounded-full shadow-lg px-4 md:px-6 py-2 md:py-3 font-cursive text-base md:text-lg transition-all duration-200 hover:scale-105",onClick:()=>p(!0),children:[t.jsx("span",{className:"hidden md:inline",children:"写一封新的祝福"}),t.jsx("span",{className:"md:hidden",children:"写祝福"})]}),t.jsx(s,{children:f&&t.jsx(l.div,{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:t.jsxs(l.div,{className:"bg-[#FFF8F5]/95 rounded-2xl shadow-2xl p-8 max-w-lg w-full relative flex flex-col md:flex-row gap-6",initial:{scale:.9},animate:{scale:1},exit:{scale:.9},children:[t.jsxs("div",{className:"flex-1 flex flex-col items-center",children:[t.jsx("div",{className:"w-16 h-16 rounded-full bg-[#BFC9FF] border-2 border-white flex items-center justify-center overflow-hidden shadow mb-2",children:f.avatar_url?t.jsx("img",{src:f.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):t.jsx("span",{className:"text-lg text-white",children:(null==(a=f.name)?void 0:a[0])||"匿"})}),t.jsx("div",{className:"font-cursive text-lg text-[#b87333] mb-2",children:f.name||"匿名"}),t.jsx("div",{className:"text-xs text-gray-400",children:new Date(f.created_at).toLocaleString()})]}),t.jsxs("div",{className:"flex-[2] flex flex-col gap-4",children:[t.jsx("div",{className:"text-[#0B0C2B] font-inter text-base whitespace-pre-line leading-relaxed border-l-2 border-[#F7D6E0]/40 pl-6 space-y-3",children:f.message}),t.jsxs("div",{className:"space-y-4",children:[f.photo_url&&t.jsx("div",{className:"rounded-xl overflow-hidden border-2 border-[#BFC9FF]",children:t.jsx("img",{src:f.photo_url,alt:"祝福照片",className:"w-full h-auto object-contain max-h-64",loading:"lazy"})}),f.audio_url&&t.jsxs("div",{className:"bg-[#F7D6E0]/20 p-3 rounded-xl",children:[t.jsx("p",{className:"text-sm text-gray-600 mb-2 font-cursive",children:"语音祝福："}),t.jsx("audio",{controls:!0,src:f.audio_url,className:"w-full"})]})]})]}),t.jsx("button",{className:"absolute right-4 top-4 text-2xl text-[#b87333] hover:text-[#F9C784]",onClick:()=>b(null),children:"✕"})]})})}),t.jsx(s,{children:N&&t.jsx(l.div,{className:"fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:t.jsxs(l.form,{onSubmit:async e=>{e.preventDefault();const t=j.trim();if(t)try{I(!0),await(async(e,t,a=null,s=null,l=null)=>{try{if(null!=l)try{return(await(r`
          INSERT INTO blessings (name, message, avatar_url, photo_url, audio_url, sticker_id)
          VALUES (
            ${e.trim().slice(0,20)||"匿名"},
            ${t.trim().slice(0,240)},
            ${""},
            ${a},
            ${s},
            ${l}
          )
          RETURNING id;
        `))[0].id}catch(i){}return(await(r`
      INSERT INTO blessings (name, message, avatar_url, photo_url, audio_url)
      VALUES (
        ${e.trim().slice(0,20)||"匿名"},
        ${t.trim().slice(0,240)},
        ${""},
        ${a},
        ${s}
      )
      RETURNING id;
    `))[0].id}catch(c){throw c}})(i,t,L,C),c(""),y(""),T(null),S(null),p(!1);const e=await o();g(e),v(!0),setTimeout(()=>v(!1),3200)}catch(a){alert(`提交失败: ${a.message}`)}finally{I(!1)}},className:"bg-[#FFF8F5]/95 rounded-t-2xl md:rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col gap-4",initial:{y:80},animate:{y:0},exit:{y:80},children:[t.jsx("div",{className:"flex gap-2",children:t.jsx("input",{className:"flex-1 px-4 py-3 rounded-xl border border-gray-200 font-cursive",placeholder:"你的名字（可留空）",value:i,onChange:e=>c(e.target.value)})}),t.jsx("textarea",{className:"w-full mt-1 px-4 py-3 rounded-xl border border-gray-200 font-inter",rows:3,placeholder:"写下你的祝福（最多 240 字）",value:j,onChange:e=>y(e.target.value)}),t.jsx("input",{type:"file",accept:"image/*",onChange:_,className:"hidden",id:"photo-upload"}),t.jsx("input",{type:"file",accept:"image/*",onChange:_,className:"hidden",id:"photo-upload"}),t.jsxs("div",{className:"mt-2 space-y-2",children:[L&&t.jsxs("div",{className:"relative w-full max-h-48 rounded-xl overflow-hidden border-2 border-[#BFC9FF]",children:[t.jsx("img",{src:L,alt:"预览",className:"w-full h-full object-contain"}),t.jsx("button",{className:"absolute top-2 right-2 w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center",onClick:()=>O("photo"),children:"✕"})]}),C&&t.jsxs("div",{className:"relative flex items-center gap-2 p-2 bg-[#F7D6E0]/20 rounded-xl",children:[t.jsx("audio",{controls:!0,src:C,className:"w-full"}),t.jsx("button",{className:"w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center flex-shrink-0",onClick:()=>O("audio"),children:"✕"})]})]}),t.jsxs("div",{className:"flex gap-2 mt-2",children:[t.jsx("label",{htmlFor:"photo-upload",className:"px-4 py-2 rounded-xl bg-[#BFC9FF] text-white font-cursive cursor-pointer hover:bg-opacity-90 transition",children:"上传照片"}),A?t.jsx("button",{type:"button",className:"px-4 py-2 rounded-xl bg-[#ff6b6b] text-white font-cursive hover:bg-opacity-90 transition",onClick:()=>{D.current&&A&&(D.current.stop(),k(!1))},children:"停止录音"}):t.jsx("button",{type:"button",className:"px-4 py-2 rounded-xl bg-[#F9C784] text-white font-cursive hover:bg-opacity-90 transition",onClick:async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(e);E.current=[],D.current=t,t.ondataavailable=e=>{e.data.size>0&&E.current.push(e.data)},t.onstop=async()=>{const t=new Blob(E.current,{type:"audio/wav"});try{const e=URL.createObjectURL(t);S(e);const a=await(async e=>{try{return new Promise(t=>{const a=new FileReader;a.onload=e=>{t(e.target.result)},a.readAsDataURL(e)})}catch(t){throw t}})(t);S(a)}catch(a){alert("上传录音失败，请重试"),S(null)}e.getTracks().forEach(e=>e.stop())},t.start(),k(!0)}catch(e){alert("请授予麦克风权限并确保设备正常")}},children:"录制语音"})]}),t.jsxs("div",{className:"flex justify-end mt-4 gap-4",children:[t.jsx("button",{type:"button",className:"px-4 py-2 rounded-xl bg-gray-200 text-gray-600 font-cursive",onClick:()=>p(!1),children:"取消"}),t.jsx("button",{type:"submit",className:"px-6 py-2 rounded-xl bg-[#A8C3A4] text-[#0B0C2B] font-cursive",children:"寄出祝福"})]})]})})})]})}export{j as default};
