import{r as e,j as t}from"./vendor-D80FRCUd.js";import{c as a}from"./database-C7DZEwQH.js";import{u as s,a as i,m as r,A as l}from"./framer-motion-BcwsrWN3.js";let n,o,c=!0;void 0!==import.meta&&!0?(n="postgresql://neondb_owner:npg_BIpmCq67lMrb@ep-quiet-pine-aefsvs3p-pooler.c-2.us-east-2.aws.neon.tech/neondb?channel_binding=require&sslmode=require",n||(c=!1,n="postgresql://user:password@localhost:5432/db?sslmode=require")):(n={}.DATABASE_URL,n||(c=!1,n="postgresql://user:password@localhost:5432/db?sslmode=require"));try{o=a(n)}catch(w){o=async()=>{throw new Error("数据库未正确配置或连接失败")}}const d=new Map,h=()=>!!c,x=async(e=!1)=>{const t="blessingsWithMedia";if(!e&&d.has(t)){const e=d.get(t);if(Date.now()-e.timestamp<3e5)return e.data}if(!h()){const e=[{id:"mock-1",name:"张三",message:"祝福你们幸福美满！",photo_url:null,audio_url:null,created_at:(new Date).toISOString()},{id:"mock-2",name:"李四",message:"祝你们百年好合！",photo_url:null,audio_url:null,created_at:new Date(Date.now()-864e5).toISOString()}];return d.set(t,{data:e,timestamp:Date.now()}),e}let a=0;for(;a<=2;)try{const e=await(o`
        SELECT id, name, message, created_at, photo_url, audio_url
        FROM blessings 
        ORDER BY created_at DESC
        LIMIT 100; -- 限制返回数量，提高性能
      `);return d.set(t,{data:e,timestamp:Date.now()}),e}catch(w){if(a++,a>2)return d.has(t)?d.get(t).data:[];await new Promise(e=>setTimeout(e,1e3*a))}return[]},u=e=>{d.delete(e)},m=({src:a,alt:s,className:i,placeholder:r,onError:l})=>{const[n,o]=e.useState(!1),[c,d]=e.useState(!1);return t.jsxs("div",{className:i,children:[!n&&!c&&r,t.jsx("img",{src:a,alt:s,className:`${i} ${n?"opacity-100":"opacity-0"}`,style:{transition:"opacity 0.3s"},onLoad:()=>o(!0),onError:e=>{d(!0),o(!0),l&&l(e)}})]})};function p({opacity:e=.1}){return t.jsxs(t.Fragment,{children:[t.jsx(r.svg,{className:"absolute left-10 top-10",width:"120",height:"60",style:{opacity:e},initial:{x:-20,opacity:0},animate:{x:0,opacity:e,y:[0,-5,0]},transition:{duration:1,y:{duration:6,repeat:1/0,ease:"easeInOut"}},children:t.jsx("ellipse",{cx:"60",cy:"30",rx:"60",ry:"30",fill:"#FFF8F5"})}),t.jsx(r.svg,{className:"absolute right-20 top-24",width:"100",height:"50",style:{opacity:e},initial:{x:20,opacity:0},animate:{x:0,opacity:e,y:[0,8,0]},transition:{duration:1.2,y:{duration:7,repeat:1/0,ease:"easeInOut"}},children:t.jsx("ellipse",{cx:"50",cy:"25",rx:"50",ry:"25",fill:"#FFF8F5"})}),t.jsx(r.svg,{className:"absolute left-1/3 bottom-10",width:"140",height:"70",style:{opacity:e},initial:{y:20,opacity:0},animate:{y:0,opacity:e,x:[0,10,0]},transition:{duration:1.5,x:{duration:8,repeat:1/0,ease:"easeInOut"}},children:t.jsx("ellipse",{cx:"70",cy:"35",rx:"70",ry:"35",fill:"#FFF8F5"})})]})}function f(){return t.jsxs(r.div,{className:"relative mx-auto mt-8 mb-12",initial:{y:60,opacity:0},animate:{y:0,opacity:1,scale:[.9,1.02,1]},transition:{duration:1,scale:{duration:.5,delay:.5}},style:{width:120,height:180},children:[t.jsx(r.div,{className:"absolute -bottom-6 left-1/2 -translate-x-1/2 w-36 h-4 bg-black/20 rounded-full blur-md",animate:{scale:[1,1.05,1]},transition:{duration:2,repeat:1/0}}),t.jsxs(r.svg,{width:"120",height:"180",viewBox:"0 0 120 180",animate:{boxShadow:["0 10px 30px rgba(184, 115, 51, 0.1)","0 15px 35px rgba(184, 115, 51, 0.2)","0 10px 30px rgba(184, 115, 51, 0.1)"]},transition:{duration:3,repeat:1/0},children:[t.jsx("ellipse",{cx:"60",cy:"30",rx:"50",ry:"20",children:t.jsx(r.animate,{attributeName:"fill",values:"#c99b57;#d4ad6f;#c99b57",dur:"5s",repeatCount:"indefinite"})}),t.jsx("rect",{x:"10",y:"30",width:"100",height:"120",rx:"20",children:t.jsx(r.animate,{attributeName:"fill",values:"#b87333;#c99b57;#b87333",dur:"5s",repeatCount:"indefinite"})}),t.jsx("ellipse",{cx:"60",cy:"150",rx:"50",ry:"20",children:t.jsx(r.animate,{attributeName:"fill",values:"#a05a2c;#b87333;#a05a2c",dur:"5s",repeatCount:"indefinite"})}),t.jsx("rect",{x:"35",y:"60",width:"50",height:"20",rx:"6",fill:"#fff"}),t.jsx("rect",{x:"45",y:"65",width:"30",height:"10",rx:"3",children:t.jsx(r.animate,{attributeName:"fill",values:"#b87333;#c99b57;#b87333",dur:"5s",repeatCount:"indefinite"})}),t.jsx(r.g,{initial:{opacity:0},animate:{opacity:[.3,1,.3]},transition:{duration:3,repeat:1/0},children:t.jsx("path",{d:"M60 30 L63 40 L75 40 L65 48 L68 60 L60 52 L52 60 L55 48 L45 40 L57 40 Z",fill:"#FFF5CC"})})]}),t.jsx(r.div,{className:"absolute left-1/2 top-16",style:{transform:"translate(-50%,0)"},animate:{y:[0,-30,0],opacity:[1,.7,1]},transition:{duration:2.5,repeat:1/0},children:t.jsxs("svg",{width:"40",height:"28",viewBox:"0 0 40 28",children:[t.jsx("rect",{x:"2",y:"4",width:"36",height:"20",rx:"4",fill:"#fff",stroke:"#b87333",strokeWidth:"2"}),t.jsx("polyline",{points:"2,4 20,18 38,4",fill:"none",stroke:"#b87333",strokeWidth:"2"}),t.jsx("path",{d:"M15 12 L18 12 L18 15 L15 15 Z",fill:"#f9c784"})]})}),t.jsx(r.div,{className:"absolute inset-0 pointer-events-none",initial:{opacity:0},animate:{opacity:[0,.4,0]},transition:{duration:2,repeat:1/0,delay:1},children:t.jsxs("svg",{width:"120",height:"180",viewBox:"0 0 120 180",children:[t.jsxs("linearGradient",{id:"shine",x1:"-50%",y1:"-50%",x2:"150%",y2:"150%",children:[t.jsx("stop",{offset:"0%",stopColor:"#fff",stopOpacity:"0"}),t.jsx("stop",{offset:"50%",stopColor:"#fff",stopOpacity:"0.3"}),t.jsx("stop",{offset:"100%",stopColor:"#fff",stopOpacity:"0"})]}),t.jsx("ellipse",{cx:"60",cy:"30",rx:"50",ry:"20",fill:"url(#shine)"}),t.jsx("rect",{x:"10",y:"30",width:"100",height:"120",rx:"20",fill:"url(#shine)"})]})})]})}function g({b:e,onClick:a}){var s;const i=()=>{var t;const a=["#b87333","#f9c784","#F7D6E0","#BFC9FF","#A8C3A4"];return a[((null==(t=e.id)?void 0:t.length)+1)%a.length||0]};return t.jsxs(r.div,{className:"relative cursor-pointer group",whileHover:{scale:1.12,zIndex:10},whileTap:{scale:.95},initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},onClick:a,style:{width:60,height:42},children:[t.jsx(r.div,{className:"absolute inset-1 rounded-lg bg-black/10 blur-sm",animate:{opacity:[.4,.6,.4]},transition:{duration:3,repeat:1/0}}),t.jsxs("svg",{width:"60",height:"42",viewBox:"0 0 60 42",children:[t.jsx("rect",{x:"2",y:"6",width:"56",height:"30",rx:"7",fill:(()=>{var t;const a=["#fff","#FFF8F5","#FFF5CC","#F0F7FF","#F5FFF8"];return a[(null==(t=e.id)?void 0:t.length)%a.length||0]})(),stroke:i(),strokeWidth:"2"}),t.jsx("polyline",{points:"2,6 30,30 58,6",fill:"none",stroke:i(),strokeWidth:"2"}),t.jsx("circle",{cx:"30",cy:"20",r:"4",fill:`${i()}30`}),t.jsx("path",{d:"M25 20 L35 20 M30 15 L30 25",stroke:i(),strokeWidth:"1",strokeLinecap:"round"})]}),t.jsx(r.div,{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-10 h-10 rounded-full border-2 border-white flex items-center justify-center overflow-hidden shadow",style:{background:`linear-gradient(135deg, ${i()}, ${i()}99)`},whileHover:{scale:1.2,rotate:5},children:t.jsx("span",{className:"text-lg text-white font-medium",children:(null==(s=e.name)?void 0:s[0])||"匿"})}),t.jsxs(r.div,{className:"absolute left-1/2 bottom-0 -translate-x-1/2 translate-y-1/2 text-xs text-white bg-black/60 px-2 py-0.5 rounded shadow whitespace-nowrap",initial:{opacity:0,y:5},whileHover:{opacity:1,y:0},transition:{duration:.2},children:[e.message.slice(0,8),e.message.length>8?"...":""]}),t.jsx(r.div,{className:"absolute inset-0 pointer-events-none",initial:{opacity:0},animate:{opacity:[0,.2,0]},transition:{duration:2,repeat:1/0,delay:3*Math.random()},children:t.jsxs("svg",{width:"60",height:"42",viewBox:"0 0 60 42",children:[t.jsxs("linearGradient",{id:`shine-${e.id}`,x1:"-50%",y1:"-50%",x2:"150%",y2:"150%",children:[t.jsx("stop",{offset:"0%",stopColor:"#fff",stopOpacity:"0"}),t.jsx("stop",{offset:"50%",stopColor:"#fff",stopOpacity:"0.3"}),t.jsx("stop",{offset:"100%",stopColor:"#fff",stopOpacity:"0"})]}),t.jsx("rect",{x:"2",y:"6",width:"56",height:"30",rx:"7",fill:`url(#shine-${e.id})`})]})})]})}function b({blessings:a}){const[s,i]=e.useState([]);return e.useEffect(()=>{const e=Array.from({length:12}).map((e,t)=>{var s,i;const r=["#ffffff","#f9c784","#F7D6E0","#BFC9FF"],l=1.5+1*Math.random(),n=10+20*Math.random(),o=.5+1*Math.random(),c=8+10*Math.random(),d=8+4*Math.random();return{id:t,left:5+90*Math.random(),delay:.1+.25*t,text:(null==(i=null==(s=a[t%a.length])?void 0:s.message)?void 0:i.slice(0,12))||"",color:r[Math.floor(Math.random()*r.length)],speed:l,length:n,thickness:o,size:c,textSize:d}});i(e);const t=setTimeout(()=>i([]),3500);return()=>clearTimeout(t)},[a]),s.length?t.jsxs("div",{className:"pointer-events-none fixed inset-0 w-full h-full z-50",children:[s.map(e=>t.jsxs(r.div,{className:"absolute",initial:{x:`${e.left}vw`,y:-50,opacity:0,rotate:-15},animate:{x:`${e.left+25}vw`,y:300,opacity:[0,1,.8,0],rotate:-15},transition:{duration:2.5/e.speed,delay:e.delay,ease:"easeOut"},children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx(r.div,{className:"h-1 rounded-full",style:{width:`${e.length}px`,background:`linear-gradient(to right, ${e.color}, transparent)`,boxShadow:`0 0 ${5*e.thickness}px ${2*e.thickness}px ${e.color}80`},animate:{opacity:[1,.5,0]},transition:{duration:2/e.speed}}),t.jsx(r.div,{className:"rounded-full",style:{width:`${e.size}px`,height:`${e.size}px`,background:e.color,boxShadow:`0 0 ${e.size}px ${e.size/2}px ${e.color}80`},animate:{scale:[1,1.2,1],opacity:[1,.7,0]},transition:{duration:2/e.speed}})]}),t.jsx(r.div,{className:"absolute bottom-4 left-1/2 transform -translate-x-1/2 whitespace-nowrap",style:{fontSize:`${e.textSize}px`},initial:{opacity:0,y:10},animate:{opacity:[0,.9,.3,0],y:[10,0,5,15]},transition:{duration:2/e.speed,delay:e.delay+.2},children:t.jsx("span",{className:"text-white drop-shadow-lg font-cursive",children:e.text})}),[...Array(5)].map((a,s)=>t.jsx(r.div,{className:"absolute rounded-full bg-white",style:{width:`${.5+Math.random()}px`,height:`${.5+Math.random()}px`},initial:{x:Math.random()*e.length,opacity:.8,y:0},animate:{x:Math.random()*e.length,y:-10-20*Math.random(),opacity:[.8,0]},transition:{duration:1/e.speed,delay:e.delay+.5*Math.random()}},`particle-${e.id}-${s}`))]},e.id)),t.jsx(r.div,{className:"absolute inset-0 bg-[#F9C784]/5 pointer-events-none",initial:{opacity:0},animate:{opacity:[0,.5,0]},transition:{duration:3.5}})]}):null}function y(){var a;const[n,c]=e.useState(""),[d,y]=e.useState(""),[j,v]=e.useState([]),[N,F]=e.useState(!0),[C,k]=e.useState(!1),[L,S]=e.useState(null),[M,E]=e.useState(!1),[R,T]=e.useState(null),[$,U]=e.useState(null),[B,_]=e.useState(!1),A=e.useRef(null),O=e.useRef([]),[I,D]=e.useState({isLoading:!0,isError:!1,errorMessage:"",lastUpdated:null,isRefreshing:!1});e.useEffect(()=>{const e=[{id:"mock1",name:"匿名祝福者",message:"新婚快乐，百年好合！",created_at:(new Date).toISOString(),photo_url:null,audio_url:null},{id:"mock2",name:"亲友团",message:"永结同心，幸福美满！",created_at:new Date(Date.now()-36e5).toISOString(),photo_url:null,audio_url:null}];v(e);const t=localStorage.getItem("hasInitializedTables"),a=async(e=!1)=>{e&&D(e=>({...e,isRefreshing:!0}));try{const t=await x(e);t&&t.length>0&&v(t),D({isLoading:!1,isError:!1,errorMessage:"",lastUpdated:new Date,isRefreshing:!1})}catch(w){D({isLoading:!1,isError:!0,errorMessage:w.message||"获取祝福列表失败，请稍后再试",lastUpdated:I.lastUpdated,isRefreshing:!1})}finally{F(!1)}};Promise.all([(async()=>{try{t||(await(async()=>{if(!h())return!1;let e=0;for(;e<=3;)try{return await(o`
        CREATE TABLE IF NOT EXISTS blessings (
          id SERIAL PRIMARY KEY,
          name VARCHAR(50) NOT NULL,
          message TEXT NOT NULL,
          photo_url TEXT,
          audio_url TEXT,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
      `),!0}catch(w){if(e++,e>3)return!1;await new Promise(t=>setTimeout(t,1e3*Math.pow(2,e-1)))}return!1})(),localStorage.setItem("hasInitializedTables","true"))}catch(w){}})(),a()]);const s=setInterval(()=>a(!0),3e5);return()=>clearInterval(s)},[]);e.useEffect(()=>{const e=setTimeout(()=>E(!0),3e4);return()=>clearTimeout(e)},[]);e.useEffect(()=>{const e=R,t=$;return()=>{e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),t&&t.startsWith("blob:")&&URL.revokeObjectURL(t),A.current&&B&&A.current.stop()}},[R,$,B]);const z=e=>{"photo"===e?(R&&R.startsWith("blob:")&&URL.revokeObjectURL(R),T(null)):"audio"===e&&($&&$.startsWith("blob:")&&URL.revokeObjectURL($),U(null))},[H,W]=e.useState({loading:!1,error:null,success:!1}),{scrollYProgress:P}=s(),q=i(P,[0,1],[0,-100]),G=i(P,[0,.5,1],[1,.7,.5]),[X,Y]=e.useState([]);return e.useEffect(()=>{const e=Array.from({length:50}).map((e,t)=>({id:t,x:100*Math.random(),y:100*Math.random(),size:.5+2*Math.random(),opacity:.3+.7*Math.random(),delay:2*Math.random(),duration:2+3*Math.random()}));Y(e)},[]),t.jsxs("div",{className:"relative min-h-[600px] bg-gradient-to-b from-[#0B0C2B] via-[#BFC9FF]/30 to-[#0B0C2B] rounded-3xl overflow-hidden shadow-xl py-12",children:[t.jsxs(r.div,{className:"absolute inset-0 pointer-events-none",style:{y:q,opacity:G},children:[X.map(e=>t.jsx(r.div,{className:"absolute rounded-full bg-white blur-sm",style:{left:`${e.x}%`,top:`${e.y}%`,width:`${e.size}px`,height:`${e.size}px`,opacity:e.opacity},animate:{opacity:[e.opacity,.5*e.opacity,e.opacity],scale:[1,1.2,1]},transition:{duration:e.duration,delay:e.delay,repeat:1/0,ease:"easeInOut"}},e.id)),t.jsx(r.div,{className:"absolute top-0 left-0 right-0 h-1/3 bg-[#F9C784]/10 blur-3xl",animate:{opacity:[.5,.8,.5]},transition:{duration:8,repeat:1/0}}),t.jsx(r.div,{className:"absolute bottom-0 left-0 right-0 h-1/3 bg-[#BFC9FF]/10 blur-3xl",animate:{opacity:[.5,.8,.5]},transition:{duration:8,repeat:1/0,delay:2}})]}),t.jsx(p,{opacity:.12}),M&&t.jsx(b,{blessings:j}),t.jsx(f,{}),t.jsxs("div",{className:"relative flex flex-wrap justify-center gap-8 px-6 mt-2 min-h-[180px] transition-all duration-500",children:[t.jsxs("div",{className:"w-full flex justify-between items-center px-4 mb-4",children:[t.jsxs("div",{className:"flex items-center",children:[I.isRefreshing&&t.jsx(r.div,{className:"w-4 h-4 border-2 border-white/60 border-t-[#F9C784] rounded-full mr-2",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}}),I.isError&&t.jsxs(r.div,{className:"text-red-400 text-sm flex items-center",initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},children:[t.jsx("span",{className:"mr-1",children:"⚠️"}),I.errorMessage]})]}),t.jsxs("div",{className:"flex items-center",children:[I.lastUpdated&&t.jsx("span",{className:"text-white/50 text-xs mr-2",children:`最后更新: ${new Date(I.lastUpdated).toLocaleTimeString()}`}),t.jsx(r.button,{onClick:async()=>{try{D(e=>({...e,isRefreshing:!0}));const e=await x(!0);e&&e.length>0&&v(e),D({isLoading:!1,isError:!1,errorMessage:"",lastUpdated:new Date,isRefreshing:!1})}catch(w){D(t=>({...t,isError:!0,errorMessage:w.message||"刷新失败，请稍后再试",isRefreshing:!1}))}},disabled:I.isRefreshing,className:"p-1 rounded-full "+(I.isRefreshing?"opacity-50":"hover:bg-white/10"),whileHover:{scale:1.1},whileTap:{scale:.9},children:t.jsx("svg",{className:"w-5 h-5 text-white/80",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})]}),N?t.jsxs(r.div,{className:"text-white/80 text-lg font-cursive flex flex-col items-center",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0},children:[t.jsx(r.div,{className:"w-8 h-8 border-4 border-white/60 border-t-[#F9C784] rounded-full mb-3",animate:{rotate:360},transition:{duration:1.5,repeat:1/0,ease:"linear"}}),"加载祝福中…"]}):j.length>0?t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"w-full flex flex-wrap justify-center gap-8",children:j.map((e,a)=>t.jsx(r.div,{initial:{opacity:0,scale:.8,y:20},animate:{opacity:1,scale:1,y:0},transition:{duration:.5,delay:Math.min(.05*a,1)},className:"mb-4",children:t.jsx(g,{b:e,onClick:()=>S(e)},e.id||`envelope-${a}`)},e.id||`envelope-${a}`))}),!C&&t.jsx(r.div,{className:"fixed bottom-8 right-8 z-30",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:260,damping:20},whileHover:{scale:1.1},whileTap:{scale:.9},children:t.jsx(r.button,{onClick:()=>k(!0),className:"w-16 h-16 bg-gradient-to-r from-[#F9C784] to-[#A8C3A4] rounded-full shadow-lg flex items-center justify-center text-white text-2xl",whileHover:{boxShadow:"0 0 15px rgba(249, 199, 132, 0.7)"},children:"✍️"})})]}):t.jsxs(r.div,{className:"text-white/80 text-center p-8 max-w-md",initial:{opacity:0},animate:{opacity:1},transition:{duration:.8},children:[t.jsx("div",{className:"text-4xl mb-4",children:"💌"}),t.jsx("div",{className:"text-lg font-cursive mb-2",children:"暂无祝福哦~"}),t.jsx("div",{className:"text-sm opacity-80 mb-6",children:"成为第一个写下祝福的人吧！"}),t.jsxs(r.button,{onClick:()=>k(!0),className:"px-6 py-3 bg-gradient-to-r from-[#F9C784] to-[#A8C3A4] rounded-xl shadow-lg flex items-center justify-center text-white font-cursive mx-auto",whileHover:{scale:1.05,boxShadow:"0 0 15px rgba(249, 199, 132, 0.7)"},whileTap:{scale:.95},children:[t.jsx("span",{className:"mr-2",children:"✍️"}),"写下祝福"]})]})]}),t.jsxs(r.button,{className:"fixed md:absolute right-4 md:right-8 bottom-4 md:bottom-8 z-30 bg-[#A8C3A4] hover:bg-[#F9C784] text-[#0B0C2B] rounded-full shadow-lg px-4 md:px-6 py-2 md:py-3 font-cursive text-base md:text-lg transition-all duration-300",onClick:()=>k(!0),whileHover:{scale:1.05,boxShadow:"0 10px 25px -5px rgba(168, 195, 164, 0.5)",rotate:2},whileTap:{scale:.98},initial:{opacity:0,y:20},animate:{opacity:1,y:0,boxShadow:["0 4px 10px rgba(168, 195, 164, 0.3)","0 6px 15px rgba(168, 195, 164, 0.4)","0 4px 10px rgba(168, 195, 164, 0.3)"]},transition:{duration:.5,boxShadow:{duration:3,repeat:1/0}},children:[t.jsx("span",{className:"hidden md:inline",children:"写一封新的祝福"}),t.jsx("span",{className:"md:hidden",children:"写祝福"}),t.jsx(r.span,{className:"inline-block ml-1 md:ml-2",animate:{rotate:[0,15,0,-15,0]},transition:{duration:2,repeat:1/0},children:"✨"})]}),t.jsx(l,{children:L&&t.jsx(r.div,{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:t.jsxs(r.div,{className:"bg-[#FFF8F5]/95 rounded-2xl shadow-2xl p-8 max-w-lg w-full relative flex flex-col md:flex-row gap-6",initial:{scale:.9},animate:{scale:1},exit:{scale:.9},children:[t.jsxs("div",{className:"flex-1 flex flex-col items-center",children:[t.jsx("div",{className:"w-16 h-16 rounded-full bg-[#BFC9FF] border-2 border-white flex items-center justify-center overflow-hidden shadow mb-2",children:L.avatar_url?t.jsx("img",{src:L.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):t.jsx("span",{className:"text-lg text-white",children:(null==(a=L.name)?void 0:a[0])||"匿"})}),t.jsx("div",{className:"font-cursive text-lg text-[#b87333] mb-2",children:L.name||"匿名"}),t.jsx("div",{className:"text-xs text-gray-400",children:new Date(L.created_at).toLocaleString()})]}),t.jsxs("div",{className:"flex-[2] flex flex-col gap-4",children:[t.jsx("div",{className:"text-[#0B0C2B] font-inter text-base whitespace-pre-line leading-relaxed border-l-2 border-[#F7D6E0]/40 pl-6 space-y-3",children:L.message}),t.jsxs("div",{className:"space-y-4",children:[L.photo_url&&t.jsx("div",{className:"rounded-xl overflow-hidden border-2 border-[#BFC9FF]",children:t.jsx(m,{src:L.photo_url,alt:"祝福照片",className:"w-full h-auto object-contain max-h-64",placeholder:t.jsxs("div",{className:"w-full h-48 flex items-center justify-center bg-gray-100",children:[t.jsx(r.div,{className:"w-8 h-8 border-3 border-[#BFC9FF] border-t-transparent rounded-full",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}}),t.jsx("span",{className:"ml-3 text-gray-400 font-cursive",children:"加载图片中..."})]}),onError:e=>{e.target.src="/photos/placeholder.svg",e.target.alt="图片加载失败",e.target.parentNode.innerHTML+='<div class="absolute inset-0 flex items-center justify-center bg-gray-100/80"><span class="text-red-500">图片加载失败</span></div>'}})}),L.audio_url&&t.jsxs("div",{className:"bg-[#F7D6E0]/20 p-3 rounded-xl",children:[t.jsx("p",{className:"text-sm text-gray-600 mb-2 font-cursive",children:"语音祝福："}),t.jsx("audio",{controls:!0,src:L.audio_url,className:"w-full"})]})]})]}),t.jsx(r.button,{className:"absolute right-4 top-4 text-2xl text-[#b87333] hover:text-[#F9C784]",onClick:()=>S(null),whileHover:{scale:1.2,rotate:90},whileTap:{scale:.9},transition:{duration:.2},children:"✕"})]})})}),t.jsx(l,{children:C&&t.jsx(r.div,{className:"fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:t.jsxs(r.form,{onSubmit:async e=>{e.preventDefault();const t=d.trim();if(!t)return W({loading:!1,error:"请输入祝福内容",success:!1}),void setTimeout(()=>W({loading:!1,error:null,success:!1}),3e3);try{W({loading:!0,error:null,success:!1}),F(!0),await(async(e,t,a=null,s=null)=>{if(!t||""===t.trim())throw new Error("消息内容不能为空");const i=(e||"").trim().slice(0,20)||"匿名",r=t.trim().slice(0,240);if(!h())return`local-${Date.now()}`;let l=0,n=null;for(;l<=2;)try{const e=await(o`
        INSERT INTO blessings (name, message, photo_url, audio_url)
        VALUES (${i}, ${r}, ${a}, ${s})
        RETURNING id;
      `);return u("blessingsWithMedia"),e[0].id}catch(w){if(l++,n=w,l>2)break;await new Promise(e=>setTimeout(e,1e3*Math.pow(2,l-1)))}throw n||new Error("提交祝福失败，请稍后再试")})(n,t,R,$),W({loading:!1,error:null,success:!0}),R&&R.startsWith("blob:")&&URL.revokeObjectURL(R),$&&$.startsWith("blob:")&&URL.revokeObjectURL($),c(""),y(""),T(null),U(null),setTimeout(()=>{k(!1),W({loading:!1,error:null,success:!1})},1500);try{const e=await x();e&&e.length>0&&v(e)}catch(a){}E(!0),setTimeout(()=>E(!1),3200)}catch(w){W({loading:!1,error:`提交失败: ${w.message||"网络错误，请稍后再试"}`,success:!1}),setTimeout(()=>W({loading:!1,error:null,success:!1}),3e3)}finally{F(!1)}},className:"bg-[#FFF8F5]/95 rounded-t-2xl md:rounded-2xl shadow-2xl p-8 w-full max-w-lg flex flex-col gap-4",initial:{y:80},animate:{y:0},exit:{y:80},children:[t.jsx("div",{className:"flex gap-2",children:t.jsx("input",{className:"flex-1 px-4 py-3 rounded-xl border border-gray-200 font-cursive",placeholder:"你的名字（可留空）",value:n,onChange:e=>c(e.target.value)})}),t.jsx("textarea",{className:"w-full mt-1 px-4 py-3 rounded-xl border border-gray-200 font-inter",rows:3,placeholder:"写下你的祝福（最多 240 字）",value:d,onChange:e=>y(e.target.value)}),t.jsx("input",{type:"file",accept:"image/*",onChange:async e=>{const t=e.target.files[0];if(t)try{if(t.size>5242880)return void alert("文件过大，请选择小于5MB的图片");F(!0);const e=URL.createObjectURL(t);T(e);const a=await(async e=>{const t=5242880;if(e.size>t)throw new Error(`照片大小超过限制 (${Math.round(5)}MB)`);if(!["image/jpeg","image/png","image/gif","image/webp"].includes(e.type))throw new Error("不支持的图片格式，请使用JPG、PNG、GIF或WEBP格式");try{return new Promise((t,a)=>{const s=new FileReader;s.onload=e=>{t(e.target.result)},s.onerror=e=>{a(new Error("读取照片文件失败"))},s.readAsDataURL(e)})}catch(w){throw new Error("上传照片失败: "+(w.message||"未知错误"))}})(t);e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),T(a)}catch(w){alert("上传照片失败，请重试"),T(null)}finally{F(!1),e.target.value=""}},className:"hidden",id:"photo-upload"}),t.jsxs("div",{className:"mt-2 space-y-2",children:[R&&t.jsxs("div",{className:"relative w-full max-h-48 rounded-xl overflow-hidden border-2 border-[#BFC9FF]",children:[t.jsx(m,{src:R,alt:"预览",className:"w-full h-full object-contain",placeholder:t.jsx("div",{className:"w-full h-32 flex items-center justify-center",children:t.jsx(r.div,{className:"w-6 h-6 border-3 border-[#BFC9FF] border-t-transparent rounded-full",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}})}),onError:e=>{e.target.src="/photos/placeholder.svg",e.target.alt="图片加载失败"}}),t.jsx("button",{className:"absolute top-2 right-2 w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center",onClick:()=>z("photo"),children:"✕"})]}),$&&t.jsxs("div",{className:"relative flex items-center gap-2 p-2 bg-[#F7D6E0]/20 rounded-xl",children:[t.jsx("audio",{controls:!0,src:$,className:"w-full"}),t.jsx("button",{className:"w-8 h-8 rounded-full bg-black/50 text-white flex items-center justify-center flex-shrink-0",onClick:()=>z("audio"),children:"✕"})]})]}),t.jsxs("div",{className:"flex gap-2 mt-2",children:[t.jsxs(r.label,{htmlFor:"photo-upload",className:"px-4 py-2 rounded-xl bg-[#BFC9FF] text-white font-cursive cursor-pointer hover:bg-opacity-90 transition",whileHover:{scale:1.03,boxShadow:"0 4px 12px rgba(191, 201, 255, 0.5)"},whileTap:{scale:.98},children:[t.jsx("span",{className:"inline-block mr-1",children:"🖼️"}),"上传照片"]}),B?t.jsxs(r.button,{type:"button",className:"px-4 py-2 rounded-xl bg-[#ff6b6b] text-white font-cursive hover:bg-opacity-90 transition",onClick:()=>{A.current&&B&&(A.current.stop(),_(!1))},whileHover:{scale:1.03,boxShadow:"0 4px 12px rgba(255, 107, 107, 0.5)"},whileTap:{scale:.98},children:[t.jsx("span",{className:"inline-block mr-1 animate-pulse",children:"🔴"}),"停止录音"]}):t.jsxs(r.button,{type:"button",className:"px-4 py-2 rounded-xl bg-[#F9C784] text-white font-cursive hover:bg-opacity-90 transition",onClick:async()=>{try{const e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(e);O.current=[],A.current=t,t.ondataavailable=e=>{e.data.size>0&&O.current.push(e.data)},t.onstop=async()=>{const t=new Blob(O.current,{type:"audio/wav"});try{const e=URL.createObjectURL(t);U(e);const a=await(async e=>{const t=2097152;if(e.size>t)throw new Error(`语音大小超过限制 (${Math.round(2)}MB)`);try{return new Promise((t,a)=>{const s=new FileReader;s.onload=e=>{t(e.target.result)},s.onerror=e=>{a(new Error("读取语音文件失败"))},s.readAsDataURL(e)})}catch(w){throw new Error("上传语音失败: "+(w.message||"未知错误"))}})(t);e&&e.startsWith("blob:")&&URL.revokeObjectURL(e),U(a)}catch(w){alert("上传录音失败，请重试"),U(null)}e.getTracks().forEach(e=>e.stop())},t.start(),_(!0)}catch(w){alert("请授予麦克风权限并确保设备正常")}},whileHover:{scale:1.03,boxShadow:"0 4px 12px rgba(249, 199, 132, 0.5)"},whileTap:{scale:.98},children:[t.jsx("span",{className:"inline-block mr-1",children:"🎤"}),"录制语音"]})]}),t.jsxs(l,{children:[H.error&&t.jsx(r.div,{className:"bg-red-50 border-l-4 border-red-400 p-3 rounded-lg text-red-700 text-sm",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0},children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"mr-2",children:"⚠️"}),t.jsx("span",{children:H.error})]})}),H.success&&t.jsx(r.div,{className:"bg-green-50 border-l-4 border-green-400 p-3 rounded-lg text-green-700 text-sm",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0},children:t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"mr-2",children:"✅"}),t.jsx("span",{children:"祝福已成功发送！"})]})})]}),t.jsxs("div",{className:"flex justify-end mt-4 gap-4",children:[t.jsx(r.button,{type:"button",className:"px-4 py-2 rounded-xl bg-gray-200 text-gray-600 font-cursive",onClick:()=>k(!1),whileHover:{scale:1.03,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)"},whileTap:{scale:.98},disabled:H.loading,children:"取消"}),t.jsx(r.button,{type:"submit",className:"px-6 py-2 rounded-xl font-cursive flex items-center justify-center min-w-[120px] "+(H.loading?"bg-gray-300 text-gray-600":"bg-[#A8C3A4] text-[#0B0C2B]"),whileHover:H.loading?{}:{scale:1.03,backgroundColor:"#F9C784",boxShadow:"0 4px 12px rgba(168, 195, 164, 0.5)"},whileTap:H.loading?{}:{scale:.98},disabled:H.loading,children:H.loading?t.jsxs(t.Fragment,{children:[t.jsx(r.div,{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2",animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"}}),"发送中..."]}):t.jsxs(t.Fragment,{children:[t.jsx("span",{className:"inline-block mr-1",children:"💌"}),"寄出祝福"]})})]})]})})}),t.jsx(r.div,{className:"absolute bottom-0 left-0 right-0 h-1 bg-gradient-to-r from-[#F9C784] via-[#BFC9FF] to-[#A8C3A4]",animate:{backgroundPosition:["0% 50%","100% 50%","0% 50%"],opacity:[.7,1,.7]},transition:{duration:8,repeat:1/0,ease:"linear"}})]})}export{y as default};
